# PMACS Utils - Docker Compose Configuration
#
# This runs an OpenConnect VPN client inside a Docker container,
# exposing proxy ports that your local applications can use.
# Your main system traffic is NOT affected by the VPN.
#
# How it works:
#   1. Container connects to PMACS GlobalProtect VPN
#   2. Container exposes SOCKS5 proxy (port 8889) and HTTP proxy (port 8888)
#   3. You configure SSH/apps to use the proxy for PMACS resources
#   4. All other traffic on your machine goes through your normal connection
#
# Usage:
#   1. Copy .env.example to .env and fill in your credentials
#   2. Run: docker compose up -d
#   3. Approve DUO push when prompted (check container logs)
#   4. Use SSH with the proxy config from ssh/config.example

services:
  vpn:
    image: wazum/openconnect-proxy:latest
    container_name: pmacs-vpn

    # Required for VPN tunnel creation
    privileged: true

    # Load credentials from .env file
    env_file:
      - .env

    ports:
      # SOCKS5 proxy - use this for SSH
      - "127.0.0.1:8889:8889"
      # HTTP/HTTPS proxy - use this for browsers/curl
      - "127.0.0.1:8888:8888"

    # Keep container running and auto-restart on failure
    restart: unless-stopped

    # Interactive mode for initial auth (DUO push)
    stdin_open: true
    tty: true

    # Health check - verify proxy is responding
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "8889"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
